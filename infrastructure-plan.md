# AWS ECS 環境構築・デプロイパイプライン実行計画書

## 目的

本計画は、Laravel + Nuxt.js + PostgreSQL のアプリケーションを AWS ECS(Elastic Container Service)環境に適切にデプロイするためのインフラストラクチャと CI/CD パイプラインを完全に構築することを目的としています。これにより、現在の図書管理システムだけでなく、将来的に他のアプリケーションにも転用可能なテンプレート環境を整備します。

## 前提条件

- AWS アカウントが準備されていること
- GitHub リポジトリが用意されていること
- ドメイン名が用意されていること（オプション）
- AWS の適切なアクセス権（管理者権限または ECS、ECR、IAM、CloudFormation 等の必要権限）

## 全体アーキテクチャ

```
[GitHub] → [GitHub Actions] → [ECR] → [ECS Fargate] → [ALB] → [CloudFront(オプション)] → [Users]
                                 ↑
                                 │
                      [Parameter Store/Secrets Manager]
                                 ↑
                                 │
                             [RDS PostgreSQL]
```

## 実行計画

### フェーズ 1: AWS 基盤インフラの構築

#### 1.1 VPC とネットワーク設定

1. **VPC 作成**

   - CIDR: 10.0.0.0/16
   - 2 つの AZ に公開サブネットと非公開サブネットを配置
   - インターネットゲートウェイの設定
   - NAT ゲートウェイの設定（非公開サブネット用）

2. **セキュリティグループ設定**
   - ALB 用セキュリティグループ: 80/443 ポートを外部に公開
   - ECS 用セキュリティグループ: ALB からの通信のみ許可
   - RDS 用セキュリティグループ: ECS からの 5432 ポートのみ許可

#### 1.2 データベース環境構築

1. **RDS PostgreSQL 設定**

   - Multi-AZ デプロイメント
   - 適切なインスタンスサイズ選定（初期は t3.micro）
   - 自動バックアップの設定
   - パラメータグループの最適化

2. **データベース初期設定**
   - データベース作成
   - ユーザー作成と権限設定
   - 初期スキーマの適用

#### 1.3 コンテナリポジトリ構築

1. **Amazon ECR リポジトリ作成**
   - バックエンド用リポジトリ
   - フロントエンド用リポジトリ
   - ライフサイクルポリシーの設定（古いイメージを自動削除）

### フェーズ 2: Docker イメージの最適化

#### 2.1 バックエンド Dockerfile 最適化

1. **マルチステージビルド導入**

   - 依存関係のインストールとアプリケーションビルドを分離
   - 本番環境に必要なファイルのみ含める
   - コンパイルツールや開発依存関係を最終イメージから除外

2. **セキュリティ対策**
   - 非 root ユーザーでの実行
   - 必要最小限の権限設定
   - 脆弱性スキャンの導入

#### 2.2 フロントエンド Dockerfile 最適化

1. **ビルド設定の最適化**

   - Node.js のマルチステージビルド
   - 静的ファイルの効率的なサービング
   - 環境変数の適切な管理

2. **Nginx 設定（フロントエンド用）**
   - 静的アセットの効率的な配信
   - キャッシュ設定の最適化
   - セキュリティヘッダーの追加

### フェーズ 3: ECS 環境の構築

#### 3.1 ECS クラスター設定

1. **Fargate クラスター作成**
   - キャパシティプロバイダー設定
   - タグ設定
   - CloudWatch Logs の統合

#### 3.2 タスク定義の作成

1. **バックエンドタスク定義**

   - CPU/メモリ割り当て
   - 環境変数の設定
   - ヘルスチェック設定
   - ログ設定

2. **フロントエンドタスク定義**
   - CPU/メモリ割り当て
   - 環境変数の設定
   - ヘルスチェック設定
   - ログ設定

#### 3.3 ECS サービス設定

1. **バックエンドサービス**

   - 自動スケーリング設定
   - ロードバランサー統合
   - ヘルスチェックグレースピリオド設定
   - デプロイ設定（ローリングアップデート）

2. **フロントエンドサービス**
   - 自動スケーリング設定
   - ロードバランサー統合
   - キャッシュ戦略

### フェーズ 4: ロードバランサーと通信経路設定

#### 4.1 Application Load Balancer (ALB) 設定

1. **ALB 作成**

   - リスナー設定 (HTTP/HTTPS)
   - ターゲットグループ設定
   - SSL 証明書の適用（ACM 使用）
   - HTTP から HTTPS へのリダイレクト設定

2. **ルーティングルール設定**
   - バックエンド API 用パスパターン (/api/\*)
   - フロントエンド用パスパターン (/\*)

#### 4.2 DNS 設定 (オプション)

1. **Route 53 設定**

   - ホストゾーン設定
   - ALB へのエイリアスレコード設定
   - ヘルスチェック設定

2. **CloudFront 設定 (オプション)**
   - キャッシュ戦略
   - エッジロケーション最適化
   - WAF 統合によるセキュリティ強化

### フェーズ 5: CI/CD パイプライン完成

#### 5.1 GitHub Secrets 設定

1. **必要なシークレットの登録**
   - AWS 認証情報
   - ECR リポジトリ情報
   - ECS サービス情報
   - データベース接続情報（セキュアに管理）

#### 5.2 GitHub Actions ワークフロー最適化

1. **テストワークフロー**

   - プルリクエスト時にテスト実行
   - コードスタイル検証
   - セキュリティスキャン

2. **デプロイワークフロー**
   - main ブランチプッシュ時の自動デプロイ
   - Docker イメージのビルドと ECR へのプッシュ
   - ECS サービス更新
   - デプロイ結果の通知設定

### フェーズ 6: モニタリングと運用体制の構築

#### 6.1 CloudWatch 設定

1. **アラーム設定**

   - CPU/メモリ使用率
   - エラーレート
   - レスポンスタイム
   - 5XX エラー

2. **ログ管理**
   - ログのグループ化
   - 保持期間設定
   - ログベースのアラート設定

#### 6.2 バックアップ戦略

1. **データベースバックアップ**

   - 自動スナップショット設定
   - クロスリージョンバックアップ（オプション）
   - 復元テスト手順の作成

2. **アプリケーションデータバックアップ**
   - S3 へのエクスポート手順作成
   - バックアップの自動化スクリプト

### フェーズ 7: セキュリティ強化

#### 7.1 IAM 権限の最適化

1. **最小権限原則の適用**

   - ECS 実行ロールの権限最小化
   - タスクロールの権限最小化
   - CI サービスの権限適正化

2. **セキュリティ監査**
   - AWS Security Hub 導入
   - AWS Config 導入
   - 定期的なセキュリティレビュー手順の策定

#### 7.2 データ保護

1. **暗号化設定**

   - RDS の暗号化
   - S3 バケットの暗号化
   - 転送中データの暗号化

2. **シークレット管理**
   - AWS Secrets Manager での機密情報管理
   - シークレットのローテーション設定

## 実施スケジュール

| フェーズ                                   | 予定期間 | 主な成果物                                 |
| ------------------------------------------ | -------- | ------------------------------------------ |
| フェーズ 1: AWS 基盤インフラの構築         | 2 日     | VPC、RDS、ECR リポジトリ                   |
| フェーズ 2: Docker イメージの最適化        | 1 日     | 最適化された Dockerfile                    |
| フェーズ 3: ECS 環境の構築                 | 2 日     | ECS クラスター、タスク定義、サービス       |
| フェーズ 4: ロードバランサーと通信経路設定 | 1 日     | ALB、ターゲットグループ、DNS 設定          |
| フェーズ 5: CI/CD パイプライン完成         | 1 日     | 最適化された GitHub Actions ワークフロー   |
| フェーズ 6: モニタリングと運用体制の構築   | 1 日     | CloudWatch アラーム、ログ設定              |
| フェーズ 7: セキュリティ強化               | 1 日     | IAM 設定、暗号化設定、セキュリティレポート |

## リスクと対策

1. **デプロイ失敗**

   - 対策: ブルー/グリーンデプロイメント導入、ロールバック手順作成

2. **コスト超過**

   - 対策: 予算アラートの設定、リソース使用量の定期監視

3. **セキュリティインシデント**

   - 対策: WAF 導入、セキュリティグループの厳格な設定、定期的な脆弱性スキャン

4. **パフォーマンス問題**
   - 対策: 適切なインスタンスサイズの選定、自動スケーリング設定、パフォーマンステスト

## 完了判定基準

1. 全てのインフラコンポーネントが正常に稼働していること
2. CI/CD パイプラインが自動的にデプロイを実行できること
3. アプリケーションが正常に機能し、外部からアクセス可能であること
4. 監視とアラートシステムが正常に機能していること
5. セキュリティ対策が適切に実装されていること
6. ドキュメントが完備されていること

## 次のステップ

この計画を承認いただいた後、フェーズ 1 から順次実行していきます。各フェーズの完了時に進捗レポートを提供し、必要に応じて調整を行います。
